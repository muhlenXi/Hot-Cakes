### 网络是怎样连接的 - 读书笔记

浏览器的第一步工作就是对 URL 进行解析。

1 条请求消息中只能写 1 个 URI。如果需要获取多个文件，必须对每个文件单独发送1条请求。

Socket 库是用于调用网络功能的程序组件集合。

根据域名查询 IP 地址时，浏览器会使用 Socket 库中的解析器。

DNS 服务器会从域名与 IP 地址的对照表中查找相应的记录，并返回 IP 地址。

向操作系统内部的协议栈发出委托时，需要按照指定的顺序来调用 Socket 库中的程序组件。

应用程序是通过 “描述符” 这一类似号码牌的东西来识别套接字的。

描述符：应用程序用来识别套接字的机制。
IP 地址和端口号：客户端和服务器之间用来识别对方套接字的机制。

浏览器、邮件等一般应用程序收发数据时用 TCP；
DNS 查询等收发较短的控制数据时用 UDP；

协议栈是根据套接字中记录的控制信息来工作的。

创建套接字时，首先分配一个套接字所需的内存空间，然后向其写入初始状态。

通信操作中使用的控制信息分为两类：

- （1）头部中记录的信息。
- （2）套接字中记录的信息。

连接操作的第一步是在 TCP 模块创建表示连接控制信息的头部。

通过 TCP 头部中的发送方和接收方端口号可以找到要连接的套接字。

MTU：一个网络包的最大长度，以太网中一般为 1500 字节。
MSS： 除去头部之后，一个网络包所能容纳的 TCP 数据的最大长度。

通过 “序号” 和 “ACK号” 可以确认接收方是否收到了网络包。

### 数据收发操作流程

> 数据收发操作的第一步是创建套接字。服务器方应用程序在启动时就会创建好套接字并进入等待链接的状态。客户端在用户触发特定操作，需要访问网络的时候创建套接字，此时，还没有传输网络包。
>
> 创建好套接字后，客户端会向服务端发起连接请求。首先客户端会生成一个 SYN 为1的 TCP 包并发给服务器，这个包的头部还包含客户端向服务器发送数据时的使用的初始序号和服务器向客户端发送数据时需要用到的窗口大小。当这个包到达服务器之后，服务器会返回一个 SYN 为1的 TCP 包，这个包也包含了序号和窗口大小，此外还包含确认收到包的 ACK 号。当这个包到达客户端时，客户端会向服务器返回一个包含表示确认的 ACK 号的 TCP 包。到这里，连接操作完成，双方进入数据收发阶段。
> 
> 收据收发完成后，服务器开始执行断开操作。服务器先发送一个 FIN 为 1 的 TCP 包，客户端收到后会返回一个表示收到的 ACK 的包。然后客户端在发送一个 FIN 为 1 的 TCP 包，服务器收到后，会返回一个表示收到的 ACK 包。最后等待一段时间，套接字会被删除。


IP 模块负责添加如下两个头部：
- 1、MAC 头部：以太网用的头部，包含 MAC 地址
- 2、IP 头部: IP 用的头部，包含 IP 地址

> 无论要收发的包是控制包还是数据包， IP 对各种类型的包的收发操作都是相同的。
> 
> IP 头部的 “接收方IP地址” 填写通信对象的 IP 地址。发送方 IP 地址需要判断发送所使用的网卡，并填写该网卡的 IP 地址。



> IP 模块根据路由表 Gateway 栏的内容判断应该把包发送给谁。
> 
> 查询 MAC 地址需要使用 ARP。


> 网卡中的 ROM 保存着全世界唯一的 MAC 地址，这是在生产网卡时写入的。
> 
> 网卡中保存的 MAC 地址会由网卡驱动程序读取并分配给 MAC 模块。


> 网卡的 MAC 模块生成通用信号，然后由 PHY（MAU）转换成可在网线中传输的格式，并通过网线发送出去。


> 集线器将信号发送给所有连接在它上面的线路。

> 交换机端口的 MAC 模块不具有 MAC 地址。
> 交换机根据 MAC 地址表查找 MAC 地址，然后将信号发送到相应的端口。
> 交换机的全双工模式可以同时发送和接收信号。


> 路由器的各个端口都具有 MAC 地址和 IP 地址。
> 路由器根据 "IP 地址" 判断转发目标。
> 路由器会忽略主机号，只匹配网络号。
> 路由器的端口都具有 MAC 地址，只接收与自身地址匹配的包，遇到不匹配的包则直接丢弃。
> 路由器也会使用 ARP 来查询下一个转发目标的 MAC 地址。


路由器判断下一个转发目标的方法：

- 如果路由表的网关列内容为 IP 地址，则该地址就是下一个转发目标。
- 如果路由表中的网关列内容为空，则 IP 头部中的接收方 IP 地址就是下一个转发目标。

> 路由表的子网掩码只表示在匹配网络包目标地址时需要对比的比特数量。
> 路由表中子网掩码为 0.0.0.0 的记录表示 "默认路由"。 

> 通过路由器转发的网络包，其接收方 MAC 地址为路由器端口的 MAC 地址。
> IP (路由器)负责将包送达通信对象这一整体过程，而其中将包传输到下一个路由器的过程则是由以太网（交换机）来负责的。


互联网接入路由器会在网络包前面加上 MAC 头部、PPPoE 头部、 PPP 头部总共三种头部， 然后发送给 ADSL Modem （PPPoE方式下）。

> ADSL Modem 将包拆分成信元，并转换成电信号发送给分离器。
> DSLAM 具有 ATM 接口，和后方服务器收发数据时使用的是原始网络包拆分后的 ATM 信元形式。

> PPPoE 是将 PPP 消息装入以太网包进行传输的方式。
> 互联网接入路由器通过 PPPoE 的发现机制查询 BAS 的 MAC 地址。


> BAS 负责将 ATM 信元还原成网络包并转发到互联网内部。
> BAS 下发的 TCP/IP 参数会被配置到互联网接入路由器的 BAS 端的端口上，这样互联网就完成接入互联网的准备了。
> BAS 在收到用户路由器发送的网络包之后，会去掉 MAC 头部和 PPPoE 头部，然后用隧道机制将包发送给网络运营商的路由器。


> 一对一连接的端口可以不分配 IP 地址，这种方式称为无编号。



**Up to page 198**